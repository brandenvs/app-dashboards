{% extends "standalone_base.html" %}
{% load static %}

{% block breadcrumb-1-label %}Apps{% endblock %}
{% block breadcrumb-1-href %}/standalone-apps/home{% endblock %}
{% block breadcrumb-2-label %}bt-bot{% endblock %}

{% block content %}
<div class="container">
    <header class="header p-2">
        <h4>Crypto Exchange Dashboard</h4>
        <button id="refresh-data" class="btn-sm btn btn-success">Refresh</button>
        <span id="timestamp">{{ exchange_data.timestamp }}</span>
        <hr>
        <div class="card text-bg-secondary mb-3">
            <div class="card-header">MARKET BRIEF</div>
            <div class="card-body">
                <p class="card-text">
                <ul class="list-group list-group-flush rounded">
                    {% for key, val in exchange_data.lgp_result.items %}
                    <li class="list-group-item">
                        {{ key }} : <b>{{ val }}</b>
                    </li>
                    {% endfor %}
                </ul>
                </p>
            </div>
        </div>
    </header>

    <div class="row g-2">
        <div class="col-md-3 col-12">
            <div class="card text-bg-secondary mb-3">
                <div class="card-header">Exchange Rates</div>
                <div class="card-body">
                    <p class="card-text">
                    <ul class="list-group list-group-flush rounded">
                        <li class="list-group-item">
                            <div class="rate-value">USD/ZAR:
                                <b>{{ exchange_data.usd_zar }}</b>
                            </div>
                        </li>
                    </ul>
                    </p>
                </div>
            </div>
            <div class="card text-bg-secondary mb-3">
                <div class="card-header">Tickers</div>
                <div class="card-body">
                    <p class="card-text">
                    <ul class="list-group list-group-flush rounded">
                        <li class="list-group-item">
                            <div class="rate-value">BTC Binance ($): <b>{{ exchange_data.binance_btc_usdt }}</b>
                            </div>
                        </li>
                        <li class="list-group-item">
                            <div class="rate-value">BTC Valr ($): <b>{{ exchange_data.valr_btc_usd }}</b>
                            </div>
                        </li>
                    </ul>
                    </p>
                </div>
            </div>
        </div>
        <div class="col-md-9 col-12">
            <div class="card highlight-card p-2">
                <h2>Live Gross Premium (LGP) Analysis</h2>
                <canvas id="lgpChart"></canvas>
            </div>
        </div>
        <div class="col-md-6 col-12">
            <div class="card p-2">
                <h2>Binance Order Book</h2>
                <div class="rate-value">Asks (ZAR converted): {{ exchange_data.binance_asks_zar }}</div>
                <div class="rate-value">Bids (ZAR converted): {{ exchange_data.binance_bids_zar }}</div>
            </div>
        </div>
        <div class="col-md-6 col-12">
            <div class="card p-2">
                <h2>Valr Order Book</h2>
                <div class="rate-value">Asks (ZAR converted): {{ exchange_data.valr_asks }}</div>
                <div class="rate-value">Bids (ZAR converted): {{ exchange_data.valr_bids }}</div>
            </div>
        </div>
        <div class="col-md-6 col-12">
            <div class="card p-2">
                <h2>Asks (Valr) vs Bids (Binance)</h2>
                <canvas id="asksValrBidsBinanceChart"></canvas>
            </div>
        </div>
        <div class="col-md-6 col-12">
            <div class="card p-2">
                <h2>Bids (Valr) vs Asks (Binance)</h2>
                <canvas id="bidsValrAsksBinanceChart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        function fetchLatestData() {
            fetch('/standalone-apps/exchange-data-api/')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('timestamp').textContent = data.timestamp;
                    updateCharts(data);
                })
                .catch(error => console.error('Error fetching data:', error));
        }

        function updateCharts(data) {
            new Chart(document.getElementById('lgpChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Binance → VALR', 'VALR → Binance'],
                    datasets: [{
                        label: 'LGP (%)',
                        data: [data.binance_to_valr_lgp, data.valr_to_binance_lgp],
                        borderColor: '#FF5722',
                        fill: false
                    }]
                }
            });

            new Chart(document.getElementById('asksValrBidsBinanceChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Asks (Valr)', 'Bids (Binance)'],
                    datasets: [{
                        data: [data.valr_asks[0][0], data.binance_bids_zar[0][0]],
                        backgroundColor: ['#FF5733', '#33FF57']
                    }]
                }
            });

            new Chart(document.getElementById('bidsValrAsksBinanceChart').getContext('2d'), {
                type: 'pie',
                data: {
                    labels: ['Bids (Valr)', 'Asks (Binance)'],
                    datasets: [{
                        data: [data.valr_bids[0][0], data.binance_asks_zar[0][0]],
                        backgroundColor: ['#3366FF', '#FF33A1']
                    }]
                }
            });
        }

        document.getElementById('refresh-data').addEventListener('click', fetchLatestData);
        fetchLatestData();
    });
</script>
{% endblock %}